{"version":3,"file":"repeat.js","sourceRoot":"","sources":["../src/lib/repeat.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright (c) 2017 The Polymer Project Authors. All rights reserved.\n * This code may only be used under the BSD style license found at\n * http://polymer.github.io/LICENSE.txt\n * The complete set of authors may be found at\n * http://polymer.github.io/AUTHORS.txt\n * The complete set of contributors may be found at\n * http://polymer.github.io/CONTRIBUTORS.txt\n * Code distributed by Google as part of the polymer project is also\n * subject to an additional IP rights grant found at\n * http://polymer.github.io/PATENTS.txt\n */\n\nimport {directive, DirectiveFn, NodePart, Part, removeNodes, reparentNodes} from '../lit-html.js';\n\nexport type KeyFn<T> = (item: T) => any;\nexport type ItemTemplate<T> = (item: T, index: number) => any;\n\nconst keyMapCache = new WeakMap<NodePart, Map<any, NodePart>>();\n\nfunction cleanMap(part: NodePart, key: any, map: Map<any, NodePart>) {\n  if (!part.startNode.parentNode) {\n    map.delete(key);\n  }\n}\n\nexport function repeat<T>(\n    items: T[], keyFn: KeyFn<T>, template: ItemTemplate<T>): DirectiveFn;\nexport function repeat<T>(items: T[], template: ItemTemplate<T>): DirectiveFn;\nexport function repeat<T>(\n    items: Iterable<T>,\n    keyFnOrTemplate: KeyFn<T>| ItemTemplate<T>,\n    template?: ItemTemplate<T>): DirectiveFn {\n  let keyFn: KeyFn<T>;\n  if (arguments.length === 2) {\n    template = keyFnOrTemplate;\n  } else if (arguments.length === 3) {\n    keyFn = keyFnOrTemplate as KeyFn<T>;\n  }\n\n  return directive((part: Part): any => {\n    if (!(part instanceof NodePart)) {\n      throw new Error('repeat can only be used on NodeParts');\n    }\n\n    let keyMap = keyMapCache.get(part);\n    if (keyMap === undefined) {\n      keyMap = new Map();\n      keyMapCache.set(part, keyMap);\n    }\n    const container = part.startNode.parentNode as HTMLElement | ShadowRoot |\n        DocumentFragment;\n    let index = -1;\n    let currentMarker = part.startNode.nextSibling!;\n\n    for (const item of items) {\n      let result;\n      let key;\n      try {\n        ++index;\n        result = template !(item, index);\n        key = keyFn ? keyFn(item) : index;\n      } catch (e) {\n        console.error(e);\n        continue;\n      }\n\n      // Try to reuse a part\n      let itemPart = keyMap.get(key);\n      if (itemPart === undefined) {\n        const marker = document.createTextNode('');\n        const endNode = document.createTextNode('');\n        container.insertBefore(marker, currentMarker);\n        container.insertBefore(endNode, currentMarker);\n        itemPart = new NodePart(part.instance, marker, endNode);\n        if (key !== undefined) {\n          keyMap.set(key, itemPart);\n        }\n      } else if (currentMarker !== itemPart.startNode) {\n        // Existing part in the wrong position\n        const end = itemPart.endNode.nextSibling!;\n        if (currentMarker !== end) {\n          reparentNodes(container, itemPart.startNode, end, currentMarker);\n        }\n      } else {\n        // else part is in the correct position already\n        currentMarker = itemPart.endNode.nextSibling!;\n      }\n\n      itemPart.setValue(result);\n    }\n\n    // Cleanup\n    if (currentMarker !== part.endNode) {\n      removeNodes(container, currentMarker, part.endNode);\n      keyMap.forEach(cleanMap);\n    }\n  });\n}\n"]}